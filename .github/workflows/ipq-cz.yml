name: OpenWrt固件编译

on:
  # 北京时间周五0点（UTC+8），转换为UTC时间是周四16点
  schedule:
    - cron: '0 16 * * 4'
  workflow_dispatch:
    inputs:
      arch:
        description: '芯片架构'
        required: true
        default: 'ipq60xx'
        type: choice
        options:
        - ipq60xx
      runner_os:
        description: '运行环境'
        required: true
        default: 'ubuntu-22.04'
        type: choice
        options:
        - ubuntu-22.04
        - ubuntu-24.04
      compile_stage:
        description: '编译阶段'
        required: true
        default: 'full'
        type: choice
        options:
        - full          # 完整编译
        - toolchain     # 从工具链编译开始
        - kernel        # 从内核编译开始
        - base          # 从基础系统编译开始
        - packages      # 从软件包编译开始（包含固件生成）

env:
  # 分支信息配置
  BRANCHES: '[
    {"name": "immortalwrt", "url": "https://github.com/laipeng668/immortalwrt.git", "branch": "master", "short": "immwrt"},
    {"name": "openwrt", "url": "https://github.com/laipeng668/openwrt.git", "branch": "master", "short": "openwrt"},
    {"name": "libwrt", "url": "https://github.com/laipeng668/openwrt-6.x.git", "branch": "k6.12-nss", "short": "libwrt"}
  ]'
  # 配置列表，按照优先级排序（Ultra > Max > Pro）
  CONFIGS: '["Ultra", "Max", "Pro"]'

jobs:
  # 准备阶段：设置环境和缓存
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      date-tag: ${{ steps.set-date.outputs.date-tag }}
    steps:
      - name: 设置日期标签
        id: set-date
        run: echo "date-tag=$(date +'%Y-%m-%d')-${{ github.event.inputs.arch || 'ipq60xx' }}" >> $GITHUB_OUTPUT
      
      - name: 设置编译矩阵
        id: set-matrix
        run: |
          # 将BRANCHES环境变量转换为矩阵格式
          matrix=$(echo '${{ env.BRANCHES }}' | jq -c '[.[] | {branch: .name, url: .url, branch_name: .branch, short: .short}]')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  # 编译阶段：并行编译各分支和配置
  build:
    needs: prepare
    runs-on: ${{ github.event.inputs.runner_os || 'ubuntu-22.04' }}
    timeout-minutes: 360  # 设置超时时间为6小时
    strategy:
      matrix:
        branch: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: 3  # 分支级并行
    container:
      image: ${{ github.event.inputs.runner_os == 'ubuntu-24.04' && 'ubuntu:24.04' || 'ubuntu:22.04' }}
    steps:
      - name: 清理磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          path: 'openwrt-build'

      - name: 设置编译环境
        run: |
          # 显示磁盘使用情况
          df -h
          
          # 设置工作目录
          mkdir -p /tmp/build
          
          # 设置ccache目录
          mkdir -p /tmp/ccache

      - name: 设置工具链缓存
        if: ${{ github.event.inputs.compile_stage != 'full' }}
        uses: actions/cache@v3
        with:
          path: /tmp/build/staging_dir
          key: ${{ runner.os }}-toolchain-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-toolchain-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}-
            ${{ runner.os }}-toolchain-${{ matrix.branch.short }}-

      - name: 设置内核缓存
        if: ${{ github.event.inputs.compile_stage == 'base' || github.event.inputs.compile_stage == 'packages' }}
        uses: actions/cache@v3
        with:
          path: /tmp/build/build_dir/target-*
          key: ${{ runner.os }}-kernel-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-kernel-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}-
            ${{ runner.os }}-kernel-${{ matrix.branch.short }}-

      - name: 设置基础系统缓存
        if: ${{ github.event.inputs.compile_stage == 'packages' }}
        uses: actions/cache@v3
        with:
          path: /tmp/build/build_dir/host-*
          key: ${{ runner.os }}-base-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-base-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}-
            ${{ runner.os }}-base-${{ matrix.branch.short }}-

      - name: 设置ccache缓存
        uses: actions/cache@v3
        with:
          path: /tmp/ccache
          key: ${{ runner.os }}-ccache-${{ matrix.branch.short }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ matrix.branch.short }}-
            ${{ runner.os }}-ccache-

      - name: 执行编译脚本
        run: |
          # 安装必要软件
          apt-get update
          apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget ccache python3 python3-pip jq
          pip3 install pyelftools
          
          # 克隆OpenWrt源码
          cd /tmp/build
          git clone --depth 1 --branch ${{ matrix.branch.branch_name }} ${{ matrix.branch.url }} openwrt
          cd openwrt
          
          # 复制配置文件和脚本
          cp -r $GITHUB_WORKSPACE/openwrt-build/* .
          
          # 设置ccache
          export CCACHE_DIR=/tmp/ccache
          ccache -M 20G
          ccache -s
          
          # 设置环境变量
          export ARCH="${{ github.event.inputs.arch || 'ipq60xx' }}"
          export BRANCH="${{ matrix.branch.name }}"
          export BRANCH_SHORT="${{ matrix.branch.short }}"
          export WORKSPACE="$GITHUB_WORKSPACE"
          export COMPILE_STAGE="${{ github.event.inputs.compile_stage }}"
          
          # 授权所有.sh脚本文件
          chmod +x $GITHUB_WORKSPACE/openwrt-build/scripts/*.sh
          
          # 执行分支准备脚本
          bash $GITHUB_WORKSPACE/openwrt-build/scripts/script-cz.sh
          
          # 编译各配置
          echo "${{ env.CONFIGS }}" | tr -d '[]"' | tr ',' '\n' | while read -r config; do
            echo "编译配置: $config"
            bash $GITHUB_WORKSPACE/openwrt-build/scripts/build-cz.sh "$config"
          done
        shell: bash

      - name: 收集编译产物
        run: |
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cd /tmp/build
          
          # 收集固件
          if [ -d "openwrt/bin/targets" ]; then
            cp -r openwrt/bin/targets $GITHUB_WORKSPACE/artifacts/
          fi
          
          # 收集配置文件
          if [ -d "openwrt/.config" ]; then
            cp openwrt/.config $GITHUB_WORKSPACE/artifacts/
          fi
          
          # 收集日志
          if [ -f "openwrt/build.log" ]; then
            cp openwrt/build.log $GITHUB_WORKSPACE/artifacts/
          fi

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.branch.short }}-${{ github.event.inputs.arch || 'ipq60xx' }}
          path: artifacts/
          retention-days: 7

  # 整理阶段：合并所有编译产物
  package:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: 下载所有编译产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: 整理产物
        run: |
          mkdir -p release
          ARCH="${{ github.event.inputs.arch || 'ipq60xx' }}"
          DATE_TAG="${{ needs.prepare.outputs.date-tag }}"
          
          # 整理固件
          for branch_dir in artifacts/build-*/; do
            if [ -d "$branch_dir/targets" ]; then
              # 提取分支缩写
              branch_short=$(basename "$branch_dir" | cut -d'-' -f2)
              
              # 处理每个固件文件
              find "$branch_dir/targets" -name "*.bin" -type f | while read firmware; do
                # 从文件名提取设备名称和固件类型
                filename=$(basename "$firmware")
                device_name=$(echo "$filename" | sed -n 's/.*-\(jdcloud_re-[cs][sp]-[0-9][0-9]\)-.*/\1/p')
                firmware_type=$(echo "$filename" | sed -n 's/.*-\(factory\|sysupgrade\)\.bin/\1/p')
                
                # 从文件名提取配置类型
                config_type=$(echo "$filename" | sed -n 's/.*-\(Pro\|Max\|Ultra\)\.bin/\1/p')
                
                # 重命名固件
                if [ -n "$device_name" ] && [ -n "$firmware_type" ] && [ -n "$config_type" ]; then
                  new_filename="${branch_short}-${device_name}-${firmware_type}-${config_type}.bin"
                  cp "$firmware" "release/$new_filename"
                fi
              done
            fi
          done
          
          # 整理配置文件
          mkdir -p release/configs
          for branch_dir in artifacts/build-*/; do
            if [ -f "$branch_dir/.config" ]; then
              branch_short=$(basename "$branch_dir" | cut -d'-' -f2)
              
              # 从配置文件中提取设备名称
              device_name=$(grep "CONFIG_TARGET_DEVICE_.*=y" "$branch_dir/.config" | head -1 | sed 's/CONFIG_TARGET_DEVICE_.*_DEVICE_\(.*\)=y/\1/')
              
              # 处理每种配置
              for config in Ultra Max Pro; do
                if [ -f "$branch_dir/.config.$config" ]; then
                  cp "$branch_dir/.config.$config" "release/configs/${branch_short}-${ARCH}-${device_name}-${config}.config"
                  cp "$branch_dir/.config.$config.buildinfo" "release/configs/${branch_short}-${ARCH}-${device_name}-${config}.config.buildinfo"
                  cp "$branch_dir/.config.$config.manifest" "release/configs/${branch_short}-${ARCH}-${device_name}-${config}.manifest" 2>/dev/null || true
                fi
              done
            fi
          done
          
          # 打包配置文件
          cd release/configs
          tar -czf "../${ARCH}-config.tar.gz" .
          cd - >/dev/null
          
          # 整理日志文件
          mkdir -p release/logs
          for branch_dir in artifacts/build-*/; do
            if [ -f "$branch_dir/build.log" ]; then
              branch_short=$(basename "$branch_dir" | cut -d'-' -f2)
              cp "$branch_dir/build.log" "release/logs/${branch_short}-build.log"
              
              # 提取错误和警告日志
              grep -i "error\|warning" "$branch_dir/build.log" > "release/logs/${branch_short}-errors-warnings.log" || true
            fi
          done
          
          # 打包日志文件
          cd release/logs
          tar -czf "../${ARCH}-log.tar.gz" .
          cd - >/dev/null
          
          # 整理软件包
          mkdir -p release/packages
          for branch_dir in artifacts/build-*/; do
            if [ -d "$branch_dir/packages" ]; then
              cp -r "$branch_dir/packages/"* release/packages/ 2>/dev/null || true
            fi
          done
          
          # 打包软件包
          cd release/packages
          tar -czf "../${ARCH}-app.tar.gz" .
          cd - >/dev/null

      - name: 创建发布说明
        run: |
          ARCH="${{ github.event.inputs.arch || 'ipq60xx' }}"
          DATE_TAG="${{ needs.prepare.outputs.date-tag }}"
          COMPILE_STAGE="${{ github.event.inputs.compile_stage }}"
          
          # 创建发布说明文件
          cat > release/NOTES.md << EOF
          ## OpenWrt固件发布
          
          **默认管理地址**: 192.168.111.1  
          **默认用户**: root  
          **默认密码**: none  
          **默认WIFI密码**: 12345678  
          
          **固件包括**: $ARCH 的京东云亚瑟、雅典娜  
          
          **编译阶段**: $COMPILE_STAGE  
          **作者**: Mary  
          **发布时间**: $(date +'%Y-%m-%d %H:%M:%S')  
          
          ### 编译的luci-app列表:
          $(ls release/packages/ 2>/dev/null | grep -E 'luci-app-.*' | sort | sed 's/^/- /' || echo "无软件包信息")
          
          ### 文件说明:
          - 固件文件: 命名规则为 [分支缩写]-[设备名称]-[固件类型]-[配置类型].bin
          - ${ARCH}-config.tar.gz: 包含所有配置文件
          - ${ARCH}-log.tar.gz: 包含编译日志
          - ${ARCH}-app.tar.gz: 包含编译的软件包
          EOF

      - name: 上传发布产物
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.event.inputs.arch || 'ipq60xx' }}
          path: release/
          retention-days: 7

  # 发布阶段：创建GitHub Release
  release:
    needs: [prepare, package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 下载发布产物
        uses: actions/download-artifact@v4
        with:
          name: release-${{ github.event.inputs.arch || 'ipq60xx' }}
          path: release/

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.date-tag }}
          name: OpenWrt固件发布 - ${{ needs.prepare.outputs.date-tag }}
          body_path: release/NOTES.md
          files: |
            release/*.bin
            release/*.tar.gz
          draft: false
          prerelease: false
